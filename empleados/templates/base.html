{% load static %}
<!DOCTYPE html>
<html lang="en">

<style>
/* ===============================
   LOGO: animaci√≥n y efecto hover
   =============================== */
.navbar-brand img {
  transition: filter 0.3s ease;
}

.navbar-brand img:hover {
  animation: pulse 0.6s ease-in-out;
  filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.7));
}

@keyframes pulse {
  0%   { box-shadow: 0 0 0 rgba(255,255,255,0); }
  50%  { box-shadow: 0 0 12px 3px rgba(255,255,255,0.7); }
  100% { box-shadow: 0 0 0 rgba(255,255,255,0); }
}


/* ===============================
   NAVBAR general
   =============================== */
.navbar {
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.navbar-brand {
  font-weight: bold;
  font-size: 1.5rem;
}


/* ===============================
   NAVBAR enlaces (nav-link)
   Iluminaci√≥n al pasar el rat√≥n
   =============================== */
.navbar .nav-link:hover {
  box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
  transition: box-shadow 0.3s ease, color 0.3s ease;
  color: #ffffff !important;
}


/* ===============================
   BOT√ìN "Buscar"
   Cambio de color sin iluminaci√≥n
   =============================== */
.navbar .btn-light {
  background-color: #ffffff;
  color: #198754;
  border: 1px solid #198754;
  transition: background-color 0.3s ease, color 0.3s ease;
}

.navbar .btn-light:hover {
  background-color: #198754;
  color: #ffffff;
  box-shadow: none !important;
}


/* ===============================
   BOTONES "Ver historial"
   Cambio de color sin iluminaci√≥n
   =============================== */
.btn-historial {
  background-color: #ffffff !important;
  color: #198754;
  border: 1px solid #198754;
  transition: background-color 0.3s ease, color 0.3s ease;
}

.btn-historial:hover {
  background-color: #198754;
  color: #ffffff;
  box-shadow: none !important;
}


/* ===============================
   FORMULARIOS y selectores
   =============================== */
.navbar-form-group {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-left: auto;
  margin-right: auto;
}

.form-select,
.btn {
  height: 40px;
  border-radius: 6px;
  font-size: 16px;
  padding: 0 12px;
}

.form-group-inline {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: center;
  margin-top: 10px;
}

.form-group-inline select,
.form-group-inline button {
  height: 40px;
  font-size: 16px;
  border-radius: 6px;
  padding: 0 12px;
}

.form-group-inline select {
  width: 200px;
}


/* ===============================
   Otros ajustes
   =============================== */
.btn-secondary {
  white-space: nowrap;
}

    .form-select,
    .btn {
      height: 40px;
      border-radius: 6px;
      font-size: 16px;
      padding: 0 12px;
    }

      .form-group-inline {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
    }

    .form-group-inline select,
    .form-group-inline button {
      height: 40px;
      font-size: 16px;
      border-radius: 6px;
      padding: 0 12px;
    }

    .form-group-inline select {
      width: 200px;
    }

  </style>


  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      {% block title %}Crud Completo Django Python MySQL {% endblock %}
    </title>
    <link rel="icon" type="image/png" href="{% static 'imgs/favicon.png'%}" />

    <!--fonts-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;1,400;1,500&display=swap"
      rel="stylesheet" />

    <!--fontawesome-->
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v6.3.0/css/all.css" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/home.css' %}" />

    {% block customCSS %} {% endblock %}
  </head>
  <body>
  {% block nav_visible %}
<nav class="navbar navbar-expand-lg bg-success navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="/">
      <img src="{% static 'imgs/fotologo/fotosambilito.png' %}" alt="Logo Sambilito" style="height: 70px;">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="container mt-3">

      <form class="d-flex align-items-center gap-2 me-3" method="GET" action="{% url 'buscar_productos' %}">
        <div class="input-group mb-3" style="max-width: 500px;">
          <span class="input-group-text bg-white border-end-0">
            <i class="fas fa-search text-muted"></i>
          </span>
          <input type="text" name="query" class="form-control border-start-0" placeholder="Buscar productos...">
          <button class="btn btn-light" type="submit">Buscar</button>
        </div>
      </form>

      <div class="d-flex gap-3">
        <form method="get" class="mb-4">
          <select name="categoria" class="form-select" onchange="this.form.submit()">
            <option value="">Todas las categor√≠as</option>
            {% for cat in categorias %}
              <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" == categoria_seleccionada %}selected{% endif %}>
                {{ cat.nombre }}
              </option>
            {% endfor %}
          </select>
        </form>

        {% if user.is_authenticated %}
        <a href="{% url 'search_history' %}" class="btn btn-light">Ver historial de b√∫squedas</a>
        <a href="{% url 'historial_compras' %}" class="btn btn-light">üßæ Ver historial de compras</a>


        {% endif %}
      </div>
    </div>

    {% csrf_token %}
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        {% if user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'cuenta' %}">Hola, {{ user.get_full_name|default:user.username }}</a>
          </li>
          <li class="nav-item">
            <a href="/logout" class="nav-link text-warning">Cerrar sesi√≥n</a>
          </li>
        {% else %}
          <li class="nav-item">
            <a href="/signin" class="nav-link">Iniciar sesi√≥n</a>
          </li>
          <li class="nav-item">
            <a href="/signup" class="nav-link">Registrarse</a>
          </li>
        {% endif %}
        <li class="nav-item">
          <a href="{% url 'info_tienda' %}" class="nav-link">Sobre Nosotros</a>
        </li>
      </ul>
    </div>
  </div>
</nav>
{% endblock %}
  <div  style="background-color: rgb(193, 241, 181);">

       
      {% include 'mensajes.html' %}
      <!---->

      {% block content %} {% endblock %}
    
    </div>

{% block separador_footer %}
  <div class="py-5" style="background-color: rgb(193, 241, 181);"></div>
{% endblock %}




<footer class="bg-success text-white pt-5 pb-4 border-top py-5">

  <div class="container">
    <div class="row">

      <!-- Informaci√≥n de la tienda -->
      <div class="col-md-3 mb-4">
        <h5 class="text-uppercase">EL SAMBILITO üõçÔ∏è</h5>
        <p class="small">
          Nacido en tiempos dif√≠ciles, comprometido con la comunidad. Calidad, cercan√≠a y confianza.
        </p>
        <p class="small fst-italic">‚ÄúTu compra con prop√≥sito üå±‚Äù</p>
      </div>

      <!-- Enlaces r√°pidos -->
      <div class="col-md-3 mb-4">
        <h6 class="text-uppercase">Enlaces</h6>
        <ul class="list-unstyled">
          <li><a href="{% url 'inicio' %}" class="text-white text-decoration-none">Inicio</a></li>
          <li><a href="{% url 'info_tienda' %}" class="text-white text-decoration-none">Sobre nosotros</a></li>
          <li><a href="{% url 'como_comprar' %}" class="text-white text-decoration-none">Ayuda</a></li>
        </ul>
      </div>


      <!-- Contacto -->
      <div class="col-md-3 mb-4">
        <h6 class="text-uppercase">Cont√°ctanos</h6>
        <p class="small mb-1"><i class="bi bi-telephone me-2"></i> +58 424-1234567</p>
        <p class="small mb-1"><i class="bi bi-envelope me-2"></i> contacto@sambilito.com</p>
        <p class="small"><i class="bi bi-geo-alt me-2"></i> V√≠a principal   El Junco, T√°chira</p>
        <p class="small"><i class="bi bi-clock me-2"></i> Lun‚ÄìS√°b: 8am ‚Äì 6pm</p>
      </div>

      <!-- Redes sociales -->
      <div class="col-md-3 mb-4">
        <h6 class="text-uppercase">S√≠guenos</h6>
        <div class="d-flex gap-3">
          <a href="#" class="text-white fs-5"><i class="bi bi-facebook"></i></a>
          <a href="#" class="text-white fs-5"><i class="bi bi-instagram"></i></a>
          <a href="#" class="text-white fs-5"><i class="bi bi-whatsapp"></i></a>
        </div>
        <p class="small mt-2">Conectados contigo, siempre ü§ù</p>
      </div>

    </div>

    <hr class="border-light">

    <div class="text-center small">
      ¬© {{ now.year }} EL SAMBILITO. Todos los derechos reservados.
    </div>
  </div>
</footer>










<script>
function copiar(id) {
  const input = document.getElementById(id);
  navigator.clipboard.writeText(input.value);
}


  //funcion para generar pedido pago movil
function enviarPedidoPagoMovil(event) {
  event.preventDefault();

  const carrito = JSON.parse('{{ carrito_json|escapejs }}');
  const metodoEntrega = localStorage.getItem("metodo_entrega") || 'no especificado';
  const codigo = document.getElementById("codigo").value;
  const tasaCambio = {{ tasa|stringformat:"f" }};
  const nombreUsuario = "{{ user.get_full_name|default:user.username }}";

  let totalUSD = 0;
  let mensaje = "üßæ *Pedido:*\n";

  for (const key in carrito) {
    const item = carrito[key];
    mensaje += `- ${item.nombre} x${item.cantidad} (${item.acumulado}$)\n`;
    totalUSD += parseFloat(item.acumulado);
  }

  const totalBs = (totalUSD * tasaCambio).toFixed(2);

  mensaje += `\nüë§ *Cliente:* ${nombreUsuario}`;
  mensaje += `\nüíµ *Total:* ${totalUSD.toFixed(2)} USD / ${totalBs} Bs`;
  mensaje += `\nüîê *numero de operacion:* ${codigo}`;
  mensaje += `\nüöö *M√©todo de entrega:* ${metodoEntrega}`;
  mensaje += `\nüîê *pago movil*`;

  // üßæ Generar PDF
  const formData = new FormData();
  formData.append('carrito', JSON.stringify(carrito));
  formData.append('nombre', nombreUsuario);
  formData.append('codigo', codigo);
  formData.append('metodo_pago', 'pago_movil'); // <-- AGREGADO AQU√ç
  formData.append('metodo_entrega', metodoEntrega);
  formData.append('total_usd', totalUSD.toFixed(2));
  formData.append('total_bs', totalBs);
  formData.append('tasa', tasaCambio);

  fetch("{% url 'generar_pdf_pedido' %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: formData
  })
  .then(response => {
    if (!response.ok) throw new Error("Error al generar PDF");
    return response.blob();
  })
  .then(blob => {
    const urlPDF = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = urlPDF;
    a.download = "pedido.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();

    // ‚úÖ Abrir WhatsApp
    const numeroTienda = "584247726393";
    const url = `https://wa.me/${numeroTienda}?text=${encodeURIComponent(mensaje)}`;
    window.open(url, "_blank");
  })
  .catch(error => {
    alert("Hubo un problema al generar el PDF.");
    console.error(error);
  });
}



//funcion para el pedido por efectivo
async function enviarPedidoEfectivo(event) {
  event.preventDefault();

  // Construye el mensaje y los datos para el PDF
  const carrito = JSON.parse('{{ carrito_json|escapejs }}');
  const nombreUsuario = "{{ user.get_full_name|default:user.username }}";
  const tasaCambio = {{ tasa|stringformat:"f" }};
  const metodoPago = "Efectivo";
  const metodoEntrega = localStorage.getItem("metodo_entrega") || "no especificado";

  let totalUSD = 0;
  for (const key in carrito) {
    totalUSD += parseFloat(carrito[key].acumulado);
  }
  const totalBs = (totalUSD * tasaCambio).toFixed(2);

  // Prepara los datos para el PDF
  const formData = new FormData();
  formData.append('carrito', JSON.stringify(carrito));
  formData.append('nombre', nombreUsuario);
  formData.append('metodo_pago', metodoPago);
  formData.append('metodo_entrega', metodoEntrega);
  formData.append('total_usd', totalUSD.toFixed(2));
  formData.append('total_bs', totalBs);
  formData.append('tasa', tasaCambio);

  // Genera el PDF
  const response = await fetch("{% url 'generar_pdf_pedido' %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: formData
  });

  if (!response.ok) {
    alert("Hubo un problema al generar el PDF.");
    return;
  }

  const blob = await response.blob();
  const urlPDF = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = urlPDF;
  a.download = "pedido.pdf";
  document.body.appendChild(a);
  a.click();
  a.remove();

  // Construye el mensaje para WhatsApp
  let mensaje = "üßæ *Pedido:*\n";
  for (const key in carrito) {
    const item = carrito[key];
    mensaje += `‚Ä¢ ${item.nombre} x${item.cantidad} (${item.acumulado}$)\n`;
  }
  mensaje += `\nüë§ *Cliente:* ${nombreUsuario}`;
  mensaje += `\nüíµ *Total:* ${totalUSD.toFixed(2)} USD / ${totalBs} Bs`;
  mensaje += `\nüí∞ *M√©todo de pago:* ${metodoPago}`;
  mensaje += `\nüöö *M√©todo de entrega:* ${metodoEntrega}`;

  // Abre WhatsApp
  const numeroTienda = "584247726393";
  const url = `https://wa.me/${numeroTienda}?text=${encodeURIComponent(mensaje)}`;
  window.open(url, "_blank");
}

</script>



    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
      integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
      crossorigin="anonymous"></script>
    <script rc="{% static 'js/home.js' %}"></script>
    {% block customJS %} {% endblock %}
    

  </body>
</html>
